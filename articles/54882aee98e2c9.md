---
title: "ZigæŽ¢è¨ª - comptimeç·¨"
emoji: "ðŸ˜Ž"
type: "tech"
topics: ["Zig"]
published: true
---

## ã‚¤ãƒ³ãƒˆãƒ­

ã•ã‚ã€ã‚„ã£ã¦å‚ã‚Šã¾ã—ãŸã€‚
ç¬¬1å›ž**ZigæŽ¢è¨ª**ã®ãŠæ™‚é–“ã§ã™ã€‚
ä»Šå›žæ‹…å½“ã™ã‚‹ã®ã¯ã€Zigã‚’ä½¿ã„å§‹ã‚ã¦æ—©ãã‚‚åŠå¹´ãƒ»æ°¸é ã®ãƒ‹ãƒ¼ãƒˆã“ã¨smallkirbyã§ã™ã€‚
ZigæŽ¢è¨ªã§ã¯ã€Zigã®æ©Ÿèƒ½ã‚„ç‰¹å¾´ã®ä¸­ã§é¢ç™½ã„ã‚“ã˜ã‚ƒãªã„ã‹ã¨æ€ã†ã‚‚ã®ã‚’ãƒ”ãƒƒã‚¯ã‚¢ãƒƒãƒ—ã—ã¦ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚
ç´¹ä»‹ã—ãªã„ã“ã¨ã‚‚ã‚ã‚Šã¾ã™ã€‚
ç¬¬1å›žã®ãƒ†ãƒ¼ãƒžã¯ã€Zigã®ä¸­ã§ã‚‚ç‰¹ã«é‡è¦ãªã‚³ãƒ³ã‚»ãƒ—ãƒˆã§ã‚ã‚‹`comptime`ã«ã¤ã„ã¦ã§ã™ã€‚

## Zigã¨ã¯ - Everything is Explicit

### Zigã«ã¤ã„ã¦ãŠã•ã‚‰ã„

ç¬¬1å›žã¨ã„ã†ã“ã¨ã§ã€æœ€åˆã«è»½ãZigã«ã¤ã„ã¦ãŠã•ã‚‰ã„ã—ã¦ãŠãã¾ã—ã‚‡ã†ã€‚

[Zig](https://ziglang.org/)ã¯ã€2016å¹´ã«é–‹ç™ºãŒå§‹ã¾ã£ãŸã‚³ãƒ³ãƒ‘ã‚¤ãƒ«åž‹æ±Žç”¨ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°è¨€èªžã§ã™ã€‚
RustãŒ2015å¹´ã«1.0ãƒªãƒªãƒ¼ã‚¹ã•ã‚ŒãŸç¿Œå¹´ã«é–‹ç™ºãŒã‚¹ã‚¿ãƒ¼ãƒˆã—ãŸã‚“ã§ã™ã­ã€‚
æœ€æ–°ã®ãƒªãƒªãƒ¼ã‚¹ã¯[v0.12.0](https://ziglang.org/download/0.12.0/release-notes.html)ã§ã‚ã‚Šã€å¤§ä½“1å¹´ãã‚‰ã„ã§ãƒžã‚¤ãƒŠãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã•ã‚Œã‚‹ã‚ˆã†ã§ã™ã€‚
ã¾ã 1.0ã«åˆ°é”ã—ã¦ã„ãªã„ãŸã‚ã€ãƒžã‚¤ãƒŠãƒ¼ã‚¢ãƒƒãƒ—ãƒ‡ãƒ¼ãƒˆã®ãŸã³ã«breaking changeãŒå…¥ã‚Šã¾ã™ã€‚
ãƒžã‚¤ãƒŠãƒ¼ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒä¸ŠãŒã‚‹ã¨å¤§ä½“éŽåŽ»ã®ã‚³ãƒ¼ãƒ‰ã¯ãƒ“ãƒ«ãƒ‰ãŒé€šã‚‰ãªããªã‚Šã¾ã™ã€‚å¯æ„›ã„ã§ã™ã­ã€‚

ç¾åœ¨ã®[ä¼æ¥­ã‚¹ãƒãƒ³ã‚µãƒ¼](https://ziglang.org/)ã¯5ç¤¾ã§ã€ãã®ä¸­ã«ã¯[æ™‚é›¨å ‚](https://shiguredo.jp/)ã‚‚å«ã¾ã‚Œã¦ã„ã¾ã™ã€‚
ã©ã“ãžã®Rustã‚„Golangã¨é•ã£ã¦åã ãŸã‚‹å¤§ä¼æ¥­ãŒãƒãƒƒã‚¯ã«ã¤ã„ã¦ã„ã¾ã›ã‚“ã€‚
èª°ã‹ãŠé‡‘ãŒä½™ã‚Šã™ãŽã¦å›°ã£ã¦ã„ã‚‹äººã¯ã‚¹ãƒãƒ³ã‚µãƒ¼ã™ã‚‹ã¨è‰¯ã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚

ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¯åˆ†æ•£åž‹ã§ã™ã€‚
GitHubã®Issueã§ã¯[QuestionãŒæ˜Žç¤ºçš„ã«ç¦æ­¢](https://github.com/ziglang/zig/issues/new/choose)ã•ã‚Œã¦ã„ã¾ã™ã€‚
ãã®ä»£ã‚ã‚Šã€ã„ãã¤ã‚‚å­˜åœ¨ã™ã‚‹[ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£](https://github.com/ziglang/zig/wiki/Community)ã§ã®è³ªå•ãŒæŽ¨å¥¨ã•ã‚Œã¦ã„ã¾ã™ã€‚
IRCãŒä¸€ç•ªæœ€åˆã«æ¥ã¦ã„ã‚‹ã®ã«ã¯è‹¥å¹²ã®å¤è‡­ã•ã‚’æ„Ÿã˜ã¾ã™ãŒã€Discordã‚„ã‚‰Slackã‚„ã‚‰è‰²ã€…ã¨ã‚ã‚Šã¾ã™ã€‚
ãã‚Œãžã‚Œã®ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã¯ç‹¬ç«‹ã—ã¦å­˜åœ¨ã—ã¦ãŠã‚Šã€å…¬å¼ãƒ»éžå…¬å¼ã®åŒºåˆ¥ãŒãªãã€ãã‚Œãžã‚Œã®ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ãŒå­˜åœ¨ã—ã¦ã„ã¾ã™ã€‚
Zigã®Lead Developerã§ã‚ã‚‹[Andrew Kelley](https://andrewkelley.me/)ã¯GitHubã®ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ã¨ã„ã†ã ã‘ã§ã‚ã‚Šã€ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£å…¨ä½“ã®ãƒ¢ãƒ‡ãƒ¬ãƒ¼ã‚¿ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
ã¼ãã®æŽ¨ã—ã¯[Ziggit](https://ziggit.dev/)ã§ã™ã€‚

ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£ã“ãè¦ªåˆ‡ã§ã™ãã«ç­”ãˆãŒè¿”ã£ã¦ãã¾ã™ãŒã€Zigã¯ã¾ã å…¨ä½“çš„ã«**ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒåœ§å€’çš„ã«è¶³ã‚Šã¦ã„ã¾ã›ã‚“**ã€‚
[å…¬å¼ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://ziglang.org/documentation/master/)ã¯ä¸€é€šã‚Šç¶²ç¾…ã—ã¦ã„ã‚‹ã‚‚ã®ã®ã€ç—’ã„ã¨ã“ã‚ã«æ‰‹ãŒå±Šã‹ãšã€ä¾ç„¶ã¨ã—ã¦TODOã¨ãƒžãƒ¼ã‚¯ã•ã‚ŒãŸç®‡æ‰€ã‚‚æ•£è¦‹ã•ã‚Œã¾ã™ã€‚
ã¨ã‚Šã‚ã‘ã€ãƒ“ãƒ«ãƒ‰ã‚·ã‚¹ãƒ†ãƒ ã®ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã¯ç„¡ã„ã¨è¨€ã£ã¦ã‚‚éŽè¨€ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚
æœ€è¿‘ã«ãªã£ã¦å…¬å¼ãŒ[ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ](https://ziglang.org/learn/build-system/)ã‚’å‡ºã—ã¾ã—ãŸãŒã€ã‚„ã¯ã‚Šã”ãä¸€éƒ¨ã‚’èª¬æ˜Žã—ã¦ã„ã‚‹ã«éŽãŽã¾ã›ã‚“ã€‚
ç¾åœ¨ã®ã¨ã“ã‚ã€Zigã®ä¸€ç•ªã®å­¦ç¿’æ•™æã¯Zigã®[stdlib](https://github.com/ziglang/zig/tree/master/lib)ã§ã™ã€‚
ã‚‚ã—ãã¯ã€[Bun](https://github.com/oven-sh/bun)ã‚‚è‰¯ã„æ•™æã§ã™(ã„ãã‚‰è‰¯ã„è¨€èªžã¨ã¯ã„ãˆã€ã¾ã 1.0ãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¦ãªã„è¨€èªžã§all-in-oneãªJSãƒ©ãƒ³ã‚¿ã‚¤ãƒ ã‚’é–‹ç™ºã™ã‚‹ã£ã¦ã€ã‚¤ã‚«ã‚Œã¦ã¾ã™ã‚ˆã­)ã€‚
ã‚ã¨ã¯Andrew Kellyã®GitHubã‚’è¦‹ã¦å€‹äººçš„ã«æ›¸ã„ã¦ã‚‹ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã‚’è¦‹ãŸã‚Šã™ã‚‹ã®ã‚‚å‹‰å¼·ã«ãªã‚Šã¾ã™ã€‚
ã¨ã‚Šã‚ãˆãšãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆãŒç„¡ã„ã¨ã„ã†ã“ã¨ã ã‘åˆ†ã‹ã‚Œã°OKã§ã™ã€‚

### è¦‹ãŸã‚‰ã‚ã‹ã‚‹ã€ãžã‚ŒãŒZig

ã•ã¦ã€å°‘ã—è©±ãŒé€¸ã‚Œã¾ã—ãŸãŒã€Zigã®ç‰¹å¾´ã¯***"å…¨ã¦ãŒæ˜Žç¤ºçš„"***ã¨ã„ã†ã¨ã“ã‚ã ã¨æ€ã£ã¦ã„ã¾ã™ã€‚
è¨€ã„æ›ãˆã‚‹ãªã‚‰ã€ãŸã ã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒ‡ã‚£ã‚¿ã§ã‚‚èª­ã¿ã‚„ã™ã„è¨€èªžã§ã™ã€‚

ãŸã¨ãˆã°ä»¥ä¸‹ã®ã‚ˆã†ãªC++ã®ã‚³ãƒ¼ãƒ‰ãŒã‚ã£ãŸã¨ã—ã¾ã—ã‚‡ã†:

```cpp
auto handle = device.open(desc + 2);
```

ã“ã®æ™‚ã€åƒ•ã®ã‚ˆã†ãªè¿·ãˆã‚‹C++ beginneré”ã¯ã“ã†æ€ã†ã‚ã‘ã§ã™:

- ðŸ¤”ã€Œãˆãƒ¼ã¨ã€ã¾ãš`device`ã®åž‹ã¯`class Device`ã ã‹ã‚‰ãƒ˜ãƒƒãƒ€ãƒ•ã‚¡ã‚¤ãƒ«ã«é£›ã‚“ã§...ã€
  - ðŸ¤”ã€Œã¯ãƒ¼ã‚“ã€`device::Device`ã¯`open()`ã£ã¦ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰æŒã£ã¦ã‚‹ã‹ã‚‰ã“ã‚Œã®ã“ã¨ã ãªã€œã€
    - ðŸ¤”ã€Œã‚ã‚Œã€ã“ã®é–¢æ•°ã»ã¼ä½•ã‚‚ã—ã¦ãªã„ã‚„ã‚“ã‘ï¼ã©ã†ãªã£ã¦ã‚“ã­ã‚“ï¼ã€
    - ðŸ¤”ã€Œã‚ã€ã“ã®`class UsbDevice`ã£ã¦å­ã‚¯ãƒ©ã‚¹ã‚ã‚‹ã‚„ã‚“ã‘ã€ãã£ã¡ã‚’å‘¼ã‚“ã§ã‚‹ã®ã­ã€
      - ðŸ¤”ã€Œã‚ã‚Œã€å¾…ã¦ã‚ˆã€‚ã“ã®`device`ã£ã¦ã‚‚ã¨ã‚‚ã¨ã©ã£ã¡ã¨ã—ã¦ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åŒ–ã•ã‚Œã¦ã‚‹ã‚“ã ã€
      - ðŸ¤”ã€ŒãŠã„ãŠã„ã€`class MouseDevice`ã£ã¦ã„ã†ã•ã‚‰ã«å­ä¾›ã®ã‚¯ãƒ©ã‚¹ã‹ã‚ˆï¼ã€
  - ðŸ¤”ã€Œã‚ã‚Œã€`desc`ã£ã¦ã„ã†å¤‰æ•°ã¯ä»Šã®ã‚¹ã‚³ãƒ¼ãƒ—ã§å®šç¾©ã•ã‚Œã¦ãªã„ã‘ã©...?ã€
    - ðŸ¤”ã€Œã‚ã€œã€ã¯ã„ã¯ã„ã€‚ã“ã®ã‚¯ãƒ©ã‚¹ã®ãƒ¡ãƒ³ãƒå¤‰æ•°ã­ã€‚äº†è§£äº†è§£ã€
- ðŸ¤” ã€Œ`desc`åž‹ã¯ãŸã `int`ã‚’ãƒ©ãƒƒãƒ—ã—ã¦ã‚‹`struct Descriptor`æ§‹é€ ä½“ã£ã½ã„ãªã€
  - ðŸ¤”ã€Œã‚ï¼Ÿã“ã®æ§‹é€ ä½“`+`ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã‚’ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‹ãªã€ãµã–ã‘ã‚„ãŒã£ã¦ã€‚ã€
- ðŸ¤” ã€Œ`MouseDevice::open()`ã®å®šç¾©2ã¤ã‚ã‚‹ã‚„ã‚“ã‘ã€ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰ã‚„ã‚„ã“ã—ã„ã‚“ã˜ã‚ƒã€‚ã€
- ðŸ¤” ã€Œã¯ï¼Ÿã©ã£ã¡ã®å®šç¾©ã‚‚`struct Descriptor`ãªã‚“ã¦å–ã‚‰ãªã„ã‚„ã‚“ã‘ã€
  - ðŸ¤”ã€Œã‚ãƒ¼ã€ã¯ã„ã¯ã„ã€‚`open()`ã®å¼•æ•°ã«ãªã‚‹ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«`explicit`ã¤ã„ã¦ãªã„ã‚ã€‚æš—é»™å¤‰æ›èµ·ã“ã‚‹ã®ã­ã€
- ðŸ¤” ã€Œã“ã®è¿”ã‚Šå€¤ã«ãªã‚‹ã‚¯ãƒ©ã‚¹ã¯ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ä¸­ã§ãƒ’ãƒ¼ãƒ—ã‹ã‚‰ãƒ¡ãƒ¢ãƒªå–ã‚‹ã®ã­ã€
  - ðŸ¤” ã€Œã¨ã“ã‚ã§ã“ã®ãƒ’ãƒ¼ãƒ—é ˜åŸŸã¯ã„ã¤è§£æ”¾ã™ã‚Œã°ã„ã„ã®ï¼Ÿã€
    - ðŸ¤” ã€Œã¾ã‚æµçŸ³ã«ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã§å‹æ‰‹ã«è§£æ”¾ã™ã‚‹ã®ã‹ãªã€‚ã„ã‚„ã€ã§ã‚‚`Finalize()`ã£ã¦ã„ã†ãƒ¡ã‚½ãƒƒãƒ‰ã‚‚ã‚ã‚‹ã‘ã©ï¼Ÿã€

ã¾ã‚ã¡ã‚‡ã£ã¨å†—é•·ã«æ›¸ãã™ãŽã¾ã—ãŸã€‚æµçŸ³ã«ã‚ªãƒ¼ãƒãƒ¼ã§ã™ã‘ã©ã€æ…£ã‚Œã¦ãªã„äººã ã¨ã“ã®ãã‚‰ã„å³å¾€å·¦å¾€ã—ã¡ã‚ƒã†ã‚ã‘ã§ã™ã€‚
ç‰¹ã«VSCodeä¸Šã§å‘¼ã‚“ã§ã‚‹ã¨ããªã‚‰ã¾ã ã—ã‚‚ã€GitHubä¸Šã§èª­ã‚“ã§ã„ã‚‹æ™‚ã«ã¯ã‚‚ã†ãªã‚“ã®ã“ã£ã¡ã‚ƒåˆ†ã‹ã‚‰ãªããªã‚Šã¾ã™ã€‚

å¯¾ã—ã¦ã€Zigã¯æ§˜ã€…ãªæ©Ÿèƒ½ã‚’å‰Šã£ã¦ãŠã‚Šã€ã‹ã¤å…¨ã¦ãŒæ˜Žç¤ºçš„ã«ãªã£ã¦ã„ã¾ã™:

- é–¢æ•°ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ­ãƒ¼ãƒ‰: ã§ãã¾ã›ã‚“ã€‚
- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå¼•æ•°: ã‚ã‚Šã¾ã›ã‚“ã€‚
- æš—é»™çš„ãªåž‹å¤‰æ›: ä¸€åˆ‡å‡ºæ¥ã¾ã›ã‚“ã€‚`i8`ã‹ã‚‰`i16`ã‚‚ã§ãã¾ã›ã‚“ã€‚`1`ã¨`true`ã‚‚ã§ãã¾ã›ã‚“ã€‚å‹æ‰‹ã«ã‚¯ãƒ©ã‚¹ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
- ä¾‹å¤–: ã‚ã‚Šã¾ã›ã‚“ã€‚ã‚¨ãƒ©ãƒ¼ã«ãªã£ãŸã‚‰early returnã™ã‚‹syntax sugarã¯ã‚ã‚Šã¾ã™ãŒã€ã‚¹ã‚¿ãƒƒã‚¯ã‚’catchã•ã‚Œã‚‹ã¾ã§é¡ã‚‹ã‚ˆã†ãªé®­ã¿ãŸã„ãªäº‹ã‚‚ã—ã¾ã›ã‚“ã€‚
- ç¶™æ‰¿: ã‚ã‚Šã¾ã›ã‚“ã€‚`union`ã‚’ä½¿ã£ã¦ä¼¼ãŸã‚ˆã†ãªã“ã¨ã¯ã§ãã¾ã™ãŒã€ã‚‚ã£ã¨ã„ã„æ–¹æ³•ãŒã‚ã‚‹ã§ã—ã‚‡ã†ã€‚
- ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ã®ã‚ªãƒ¼ãƒãƒ¼ãƒ©ã‚¤ãƒ‰: ã‚ã‚‹ã‚ã‘ãªã„ã‚ˆã­ã€‚
- ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãƒ»ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿: ã‚ã‚Šã¾ã›ã‚“ã€‚å‹æ‰‹ã«é–¢æ•°å‘¼ã°ã‚ŒãŸã‚‰æ€–ã„ã‚ˆã­ã€‚Golangã¿ãŸã„ã«`defer`ã§ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŠœã‘ã‚‹éš›ã®å‡¦ç†ã‚’è¨˜è¿°ã™ã‚‹ã“ã¨ã¯å‡ºæ¥ã¾ã™ã€‚
- æš—é»™çš„ãªãƒ¡ãƒ¢ãƒªç¢ºä¿: ã‚ã‚Šã¾ã›ã‚“ã€‚ãƒ’ãƒ¼ãƒ—ã¸ã®ãƒ¡ãƒ¢ãƒªç¢ºä¿ã¯å…¨ã¦æ˜Žç¤ºçš„ã«è¡Œã†å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚ãƒ’ãƒ¼ãƒ—ã‚’ä½¿ã†stdlibã®é–¢æ•°ã«ã¯`Allocator`ã‚’é–¢æ•°ã«æ¸¡ã™å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
- ãƒžã‚¯ãƒ­: ã‚ã‚Šã¾ã›ã‚“ã€‚åž‹ãŒãªã„ã®ã€æ€–ã„ã¨æ€ã‚ãªã„ï¼Ÿæ‹¬å¼§ã‚’ã¤ã‘å¿˜ã‚ŒãŸã ã‘ã§æ„å‘³ã‚ã‹ã‚‰ãªã„ã‚¨ãƒ©ãƒ¼ã¨ã‹å‡ºãŸã“ã¨ç„¡ã„ï¼Ÿãã®ä»£ã‚ã‚Šã¨ã„ã£ã¡ã‚ƒãªã‚“ã§ã™ãŒã€`comptime`ã¨ã„ã†æ©Ÿèƒ½ãŒã‚ã£ã¦ã€ã ã„ãŸã„ãã‚Œã§å®Ÿç¾ã§ãã¾ã™ã€‚

ã“ã‚Œã‚‰ã®æ©Ÿèƒ½ãŒå‰Šã‚‰ã‚ŒãŸçµæžœã€Zigã®ã‚³ãƒ¼ãƒ‰ã¯éžå¸¸ã«èª­ã¿ã‚„ã™ããªã‚Šã¾ã™ã€‚
ä¸Šã®ä¾‹ã®å ´åˆã«ã¯ã€`struct Device`ã®å”¯ä¸€ã®`open()`é–¢æ•°ãŒå‘¼ã°ã‚Œã€ãã®å¼•æ•°ã®åž‹(ã™ãªã‚ã¡`desc`ã®ã¾ã•ã«ãã®åž‹)ã‚‚ä¸€æ„ã«å®šã¾ã‚Šã€ãã“ã«ã¯ä½•ã®å¤‰æ›ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
`device`ãŒã‚¢ãƒ­ã‚±ãƒ¼ã‚¿ã‚’æŒã£ã¦ã„ãªã„ãªã‚‰ã°`open()`ã§ãƒ’ãƒ¼ãƒ—ãŒç¢ºä¿ã•ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
`desc + 2`ã¯èª­ã‚“ã§å­—ã®ã”ã¨ãæ•°ã®è¶³ã—ç®—ã«ä»–ãªã‚‰ãšã€`desc`ã¯æ•°(æ•´æ•°/æµ®å‹•å°æ•°ç‚¹æ•°)ã®åž‹ã§ã‚ã‚‹ã“ã¨ã‚‚è‡ªæ˜Žã§ã™ã€‚
ã‚¹ã‚³ãƒ¼ãƒ—ã‚’æŠœã‘ã¦ã‚‚å‹æ‰‹ã«ãƒ‡ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ãŒå‘¼ã°ã‚Œã‚‹ã“ã¨ã‚‚ã‚ã‚Šã¾ã›ã‚“ã€‚
ã‚ã‹ã‚Šã‚„ã™ã„ã­ï¼

ãã†ã„ã†ã‚ã‘ã§ã€Zigã¯ä»–ã®è¨€èªžã‹ã‚‰ã„ã‚ã„ã‚ãªæ©Ÿèƒ½ã‚’å‰ŠãŽè½ã¨ã—ã¦ã—ã¾ã£ã¦ã„ã‚‹ã‚ã‘ã§ã™ãŒã€ãã‚Œã§ã‚‚å¼·åŠ›ãªè¨€èªžæ©Ÿèƒ½ã‚’ã„ãã¤ã‹æŒã£ã¦ã„ã¾ã™ã€‚
ä»Šå›žã¯ãã®ä¸­ã§ã‚‚é‡è¦ã§ã‚ã‚Šã€ã‹ã¤å‹‰å¼·ã—ãŸã¦ã®é ƒã«ã¯ã„ã¾ã„ã¡æ‰±ã„ã¥ã‚‰ã„`comptime`ã«ã¤ã„ã¦ç´¹ä»‹ã—ã¦ã„ãã¾ã™ã€‚

## `comptime`æ¦‚ç•¥

Zigã¯ã€ã€Œã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ±ºã¾ã‚‹å€¤ã‹å¦ã‹ã€ã‚’ã‚ã£ã¡ã‚ƒæ°—ã«ã—ã¾ã™ã€‚ç¥žçµŒè³ªã§ã™ã€‚
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«æ±ºã¾ã‚‹ã‹å¼ã®ã“ã¨ã‚’ã€[`comptime`ãªå€¤](https://ziglang.org/documentation/master/#toc-comptime)ã¨å‘¼ã³ã¾ã™ã€‚
å€¤ãŒ`comptime`ã‹ã©ã†ã‹ã¯ã€ã‚ã‚‹ç¨‹åº¦ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ãŒãƒ«ãƒ¼ãƒ«ã«åŸºã¥ã„ã¦æ±ºå®šã—ã¾ã™ã€‚
ã¾ãŸã€é–‹ç™ºè€…ãŒæ˜Žç¤ºçš„ã«åž‹ã«`comptime`ä¿®é£¾ã‚’ã™ã‚‹ã“ã¨ã§ã€ãã®å€¤ãŒ`comptime`ã§ã‚ã‚‹ã“ã¨ã‚’å¼·åˆ¶ã™ã‚‹ã“ã¨ã‚‚å‡ºæ¥ã¾ã™ã€‚

ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆçš„ãªèª¬æ˜Žã¯[Zig Language Reference](https://ziglang.org/documentation/master/#toc-comptime)ã«è­²ã‚‹ã“ã¨ã¨ã—ã¦ã€ä»¥ä¸‹ã§ã¯é¢ç™½ã„ä¾‹ã‚’è¦‹ã¦ã„ãã¾ã›ãµã€‚

## Case 1: MMIO

ãƒ‹ãƒ¼ãƒˆãªã®ã§æš‡ãªæ™‚é–“ã«[MikanOS](https://github.com/uchan-nos/mikanos)ã‚’[Zigã«ç§»æ¤](https://github.com/smallkirby/zakuro-os)ã—ã¦éŠã‚“ã§ã„ã‚‹ã‚“ã§ã™ãŒã€ãã®ä¸­ã§xHCI(USB)ãƒ‰ãƒ©ã‚¤ãƒã‚’æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚
xHCã¯æ§˜ã€…ãªãƒ¬ã‚¸ã‚¹ã‚¿ã‚’æŒã£ã¦ã„ã¾ã™:

```zig
pub const CapabilityRegisters = packed struct {
    cap_length: u8,
    hci_version: u16,
    ...
}
```

`packed struct`ã¯ãƒ¡ãƒ³ãƒé–“ã®ãƒ‘ãƒ‡ã‚£ãƒ³ã‚°ã‚’ãªãã—ã¦ãã‚Œã‚‹æ§‹é€ ä½“ã§ã™ã€‚
ã¾ãŸã€Zigã§ã¯æ•´æ•°åž‹ã¨ã—ã¦ä»»æ„ã®ãƒ“ãƒƒãƒˆå¹…ã‚’ã¨ã‚‹ã“ã¨ãŒã§ãã‚‹ãŸã‚ã€`u8`ã§ã‚‚`u16`ã§ã‚‚`u99`ã§ã‚‚ä½¿ã†ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚
ãã‚Œã¯è‰¯ã„ã“ã¨ã§ã™ãŒã€ã“ã†ã„ã£ãŸMMIOãƒ¬ã‚¸ã‚¹ã‚¿ã¯ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹éš›ã®ãƒ“ãƒƒãƒˆå¹…ãŒä»•æ§˜ã§æ±ºã¾ã£ã¦ã„ã‚‹ã“ã¨ãŒå¤šã€…ã‚ã‚Šã¾ã™ã€‚
ã‚ã‚‹ãƒ¬ã‚¸ã‚¹ã‚¿ã¯WORD(16bit)ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã€ã‚ã‚‹ãƒ¬ã‚¸ã‚¹ã‚¿ã¯`DWORD(32bit)`ã§ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã€ã¨ã„ã£ãŸå…·åˆã§ã™ã€‚
ãã‚“ãªæ™‚ã€`cap_length`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ã‚’å¤‰æ›´ã—ãŸã„ã¨ãªã£ãŸæ™‚ã«ã‚ã‚“ã©ã†ã§ã™ã€‚
ã“ã®ãƒ¬ã‚¸ã‚¹ã‚¿ãŒDWORDã‚¢ã‚¯ã‚»ã‚¹ã‚’å¼·åˆ¶ã™ã‚‹å ´åˆã€`cap_length`ã ã‘ã‚¢ã‚¯ã‚»ã‚¹ã™ã‚‹ã¨ã‚¢ã‚¯ã‚»ã‚¹é•åã«ãªã£ã¦ã—ã¾ã„ã¾ã™ã€‚

ãã‚“ãªæ™‚ã«`comptime`ãŒå½¹ã«ç«‹ã¡ã¾ã™ã€‚
ã¾ãšã¯ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ãƒ“ãƒƒãƒˆå¹…ã‚’è¡¨ã™`AccessWidth` enumã‚’å®šç¾©ã—ã¾ã™:

```zig
pub const AccessWidth = enum(u8) {
    QWORD = 8,
    DWORD = 4,
    WORD = 2,
    BYTE = 1,

    pub fn utype(comptime self: AccessWidth) type {
        return switch (self) {
            .QWORD => u64,
            .DWORD => u32,
            .WORD => u16,
            .BYTE => u8,
        };
    }

    pub fn size(comptime self: AccessWidth) usize {
        return @sizeOf(self.utype());
    }
};
```

éžå¸¸ã«ã‚·ãƒ³ãƒ—ãƒ«ã€‚
`enum(u8)`ã¯ã€ã“ã®enumã®ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒ8bitã§è¡¨ç¾ã•ã‚Œã‚‹ã“ã¨ã‚’æ˜Žç¤ºã—ã¾ã™ã€‚
ãã®ãƒ¡ãƒ³ãƒãƒ¼ã¯ãƒ“ãƒƒãƒˆå¹…ã‚’è¡¨ã™4ã¤ãŒã‚ã‚Šã¾ã™ã€‚
`utype()`ã¯ã‚¢ã‚¯ã‚»ã‚¹å¹…ã«å¯¾å¿œã™ã‚‹æ•´æ•°åž‹ã‚’è¿”ã™ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°ã§ã™ã€‚
Zigã§ã¯ã€**`comptime`ã§ã‚ã‚‹é™ã‚Š`type`ã‚’é–¢æ•°ã®è¿”ã‚Šå€¤ã¨ã™ã‚‹ã“ã¨ãŒã§ãã¾ã™**ã€‚
`size()`ã‚‚ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã§ã€enumã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ãŒè¡¨ç¾ã™ã‚‹ãƒ“ãƒƒãƒˆå¹…ã‚’è¿”ã—ã¦ãã‚Œã¾ã™ã€‚

ãã‚Œã‚’è¸ã¾ãˆã¦MMIOãƒ¬ã‚¸ã‚¹ã‚¿ã‚’è¡¨ç¾ã™ã‚‹æ§‹é€ ä½“ã‚’å®šç¾©ã—ã¾ã™:

```zig
pub fn Register(
    comptime T: type,
    comptime access_width: AccessWidth,
) type {
    return packed struct {
        const Self = @This();
        const asize = access_width.size();
        const atype = access_width.utype();
        const len = @sizeOf(T) / asize;

        /// Underlying data
        _data: T,

        /// Read the data from the underlying register with the correct access width.
        pub fn read(self: *volatile Self) T {
            var ret: T = mem.zeroes(T);
            const ret_bytes: [*]volatile atype = @ptrCast(mem.asBytes(&ret));
            const val: [*]volatile atype = @ptrCast(mem.asBytes(&self._data));
            for (0..len) |i| {
                ret_bytes[i] = val[i];
            }

            return ret;
        }
    };
}
```

ã“ã®é–¢æ•°ã¯ã€**`comptime`ãªåž‹`T`ã¨`AccessWidth`ã‚’å—ã‘å–ã‚Šã€ãã®åž‹ã‚’æŒã¤ãƒ¬ã‚¸ã‚¹ã‚¿æ§‹é€ ä½“ã‚’è¿”ã—ã¾ã™**ã€‚
ã“ã“ã§ã‚‚ã‚„ã¯ã‚Šã€é–¢æ•°ãŒåž‹ã‚’è¿”ã—ã¦ã„ã¾ã™ã€‚
ã—ã‹ã‚‚ã€è¿”ã•ã‚Œã‚‹åž‹ã¯`_data: T`ã¨ã„ã£ãŸå¼•æ•°ã§å–ã£ãŸåž‹ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
`_data`ãƒ¡ãƒ³ãƒã¯ã€å®Ÿéš›ã®ãƒ¬ã‚¸ã‚¹ã‚¿ã®ä¸­èº«ã‚’è¡¨ã™åž‹ã§ã™ã€‚
å…ˆç¨‹ã®ä¾‹ã§è¨€ã†ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã§ä½¿ã„ã¾ã™:

```zig
capability_regs: *volatile Register(CapabilityRegisters, .DWORD),
```

ã“ã‚Œã§`capability_regs`å¤‰æ•°ã¯`CapabilityRegisters`æ§‹é€ ä½“ã‚’æŒ‡ã™ãƒã‚¤ãƒ³ã‚¿ã§ã‚ã‚ŠãªãŒã‚‰ã€`DWORD`ã‚¢ã‚¯ã‚»ã‚¹ã‚’ã™ã‚‹ã“ã¨ãŒã§ãã‚‹åž‹ã‚’æŒã¤ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã•ã¦ã•ã¦ã€`Register()`ã®å®šç¾©ã«æˆ»ã‚Šã¾ã™ã€‚
`asize`/`atype`ãƒ¡ãƒ³ãƒã¯ã€ã‚¢ã‚¯ã‚»ã‚¹å¹…ã«å¯¾å¿œã—ãŸåž‹ã¨ãã®ã‚µã‚¤ã‚ºã‚’è¡¨ã—ã¦ã„ã¾ã™ã€‚
è¿”ã•ã‚Œã‚‹æ§‹é€ ä½“åž‹ã®staticãªå¤‰æ•°ã®ã‚ˆã†ãªæ‰±ã„ã«ãªã‚Šã¾ã™ã€‚
`read()`ã¯ã‚³ã‚¢ã®éƒ¨åˆ†ã§ã€ã‚¢ã‚¯ã‚»ã‚¹å¹…ã«å¯¾å¿œã—ãŸå¹…ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¤ã¤ã€ã‚‚ã¨ã®æ§‹é€ ä½“ã®åž‹ã§ãƒ‡ãƒ¼ã‚¿ã‚’è¿”ã—ã¾ã™ã€‚
ã‚„ã£ã¦ã„ã‚‹ã“ã¨ã¨ã—ã¦ã¯:

- MMIOãƒ¬ã‚¸ã‚¹ã‚¿ã‚’`val`ã¨ã„ã†ã‚¢ã‚¯ã‚»ã‚¹å¹…ã«å¯¾å¿œã™ã‚‹åž‹(`atype`)ã®é…åˆ—ã¨ã¿ãªã™ã€‚
- å®Ÿéš›ã®ãƒ¬ã‚¸ã‚¹ã‚¿åž‹(`T`)ã‚’æŒã¤ç©ºã®å¤‰æ•°`ret`ã‚’ç”¨æ„ã™ã‚‹ã€‚
- å¿…è¦ãªå›žæ•°(`len`)ã ã‘ãƒ‡ãƒ¼ã‚¿ã‚’ã‚³ãƒ”ãƒ¼ã™ã‚‹

ã¨è¨€ã£ãŸæ„Ÿã˜ã§ã™ã€‚ã¾ãå®Ÿéš›ã«ã©ã‚“ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã‹ã‚ˆã‚Šã‚‚ã€åž‹ã‚’å¼•æ•°ã«å–ã‚‹ã“ã¨ã§ãã®åž‹ã«å¿œã˜ãŸãƒ¡ã‚½ãƒƒãƒ‰ã‚’æŒã¤æ§‹é€ ä½“ã‚’ä½œã‚Œã‚‹ã¨ã„ã†ã“ã¨ãŒãƒã‚¤ãƒ³ãƒˆã§ã™ã€‚

## Case 2: Partial Type

TypeScriptã®ã‚ˆã†ãªã‚¹ã‚¯ãƒªãƒ—ãƒˆè¨€èªžã«ã¯ã€ã‚ã‚‹[åž‹ã®ä¸€éƒ¨ã ã‘ã‚’æŒã¤åž‹](https://www.typescriptlang.org/docs/handbook/utility-types.html#partialtype)ã‚’è¡¨ç¾ã™ã‚‹æ©Ÿèƒ½ãŒã‚ã‚Šã¾ã™ã€‚
ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«åž‹è¨€èªžã§ã¯ãªã‹ãªã‹ç„¡ã„æ©Ÿèƒ½ã§ã™ãŒã€Zigã§ã¯`comptime`ã‚’ä½¿ã†ã“ã¨ã§å®Ÿç¾ã§ãã¾ã™ã€‚

å…ˆç¨‹ã®ä¾‹ã§ã¯MMIOãƒ¬ã‚¸ã‚¹ã‚¿ã‹ã‚‰ã®èª­ã¿å–ã‚Šã‚’ã—ã¦ã„ã¾ã—ãŸãŒã€ã“ã“ã§ã¯é€†ã«ä¸€éƒ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã¿æ›¸ãè¾¼ã¿ãŸã„ã¨ã—ã¾ã—ã‚‡ã†ã€‚
ã“ã®æ™‚ã€ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒå‡ºæ¥ã¾ã™:

```zig
pub fn modify(self: *volatile Self, value: anytype) void {
    var new = self.read();
    const info = @typeInfo(@TypeOf(value));
    inline for (info.Struct.fields) |field| {
        @field(new, field.name) = @field(value, field.name);
    }

    self.write(new);
}
```

ã¾ãšã€`read()`ã«ã‚ˆã£ã¦ç¾åœ¨ã®å€¤ã‚’å–å¾—ã—ã¾ã™ã€‚
ãã®å¾Œã€`info`å¤‰æ•°ã«`value`å¼•æ•°ã®åž‹æƒ…å ±ã‚’å–å¾—ã—ã¾ã™ã€‚
`value`ã¯`anytype`åž‹ã‚’æŒã¡ã€`comptime`ãªä»»æ„ã®åž‹ã‚’å—ã‘å–ã‚‹ã“ã¨ãŒã§ãã¾ã™(ã‚ˆã£ã¦`comptime`ã¨ã‚ã–ã‚ã–æ›¸ãå¿…è¦ã¯ã‚ã‚Šã¾ã›ã‚“)ã€‚
ã“ã®æ™‚ã€`info.Struct.fields`ã¯`value`æ§‹é€ ä½“ãŒæŒã¤å…¨ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¡¨ã™é…åˆ—ã§ã™ã€‚
ã“ã®é…åˆ—ã‚’`for`ãƒ«ãƒ¼ãƒ—ã§å›žã™ã“ã¨ã§ã€`new`å¤‰æ•°ã®å¯¾å¿œã™ã‚‹ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«`value`ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã„ãã¾ã™ã€‚
ã“ã“ã§ç™»å ´ã™ã‚‹`inline for`ã¯`comptime`ãªå ´åˆã«ã®ã¿ä½¿ã†ã“ã¨ãŒã§ãã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«ã‚¢ãƒ³ãƒ­ãƒ¼ãƒªãƒ³ã‚°ã•ã‚Œã¾ã™ã€‚
ä»–ã«ã¯`inline switch`ã¨ã‹`inline while`ã¨ã‹ãŒã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã§ä¸€éƒ¨ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã ã‘ã‚’å¤‰æ›´ã—ãŸã„ã¨ãã«ã¯ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™:

```zig
capability_regs.modify(.{
    .cap_length = 0x10,
});
```

ã™ã”ã„ã­ã€ã‚ã£ã¡ã‚ƒä¾¿åˆ©ã ã­ï¼
(ã¡ãªã¿ã«xHCIã®Capability Registerã«ãŠã‘ã‚‹`cap_length`ã¯ROãªã®ã§æœ¬å½“ã¯æ›¸ãè¾¼ã‚“ã˜ã‚ƒã ã‚ã YO)

## Case 3: é–¢æ•°ã‚‚è¿”ã—ã¡ã‚ƒãˆ

å°‘ã—è¶£ã‚’å¤‰ãˆã¦ã€ä»Šåº¦ã¯å‰²ã‚Šè¾¼ã¿å‡¦ç†ã‚’æ›¸ããŸã„ã¨ã—ã¾ã—ã‚‡ã†ã€‚
x64ã«ãŠã„ã¦ã€CPUã¯å‰²ã‚Šè¾¼ã¿ã‚’å—ã‘ã‚‹ã¨IDTã‚’æŽ¢ã—ã¦å‰²ã‚Šè¾¼ã¿ãƒ™ã‚¯ã‚¿ãƒ¼ã«å¯¾å¿œã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ã‚’å‘¼ã³ã¾ã™ã€‚
ã“ã®ãƒãƒ³ãƒ‰ãƒ©ã§ã¯ãƒ¬ã‚¸ã‚¹ã‚¿ã®é€€é¿ãªã©ã‚’è¡Œã†ãŸã‚ã€åŸºæœ¬çš„ã«ã¯å…¨å‰²ã‚Šè¾¼ã¿ã§å…±é€šã—ãŸã‚‚ã®ã‚’ä½¿ã„ãŸã„ã§ã™ã€‚
ã—ã‹ã—ãªãŒã‚‰ã€ã“ã“ã§å•é¡ŒãŒã€‚
å…±é€šã—ãŸãƒãƒ³ãƒ‰ãƒ©ã‚’ä½¿ã†ã¨ã€**å‰²ã‚Šè¾¼ã¿ãƒ™ã‚¯ã‚¿(å‰²ã‚Šè¾¼ã¿ç•ªå·)ãŒä½•ç•ªã‹ãŒåˆ†ã‹ã‚‰ãªããªã£ã¦ã—ã¾ã„ã¾ã™**ã€‚
ã“ã‚Œã§ã¯ã€å…±é€šã—ãŸãƒãƒ³ãƒ‰ãƒ©ã‹ã‚‰ãƒ™ã‚¯ã‚¿ã«å¯¾å¿œã™ã‚‹ãƒãƒ³ãƒ‰ãƒ©ã‚’å‘¼ã³å‡ºã™ã“ã¨ãŒå‡ºæ¥ã¾ã›ã‚“ã€‚

ãã“ã§ã€Linuxãªã©ã§ã¯ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã§ä»¥ä¸‹ã®ã‚ˆã†ã«æ›¸ã„ã¦ã„ã¾ã™:

```.s
SYM_CODE_START(early_idt_handler_array)
	i = 0
	.rept NUM_EXCEPTION_VECTORS
	(...)
	pushq $i		# 72(%rsp) Vector number
	jmp early_idt_handler_common
	i = i + 1
	.fill early_idt_handler_array + i*EARLY_IDT_HANDLER_SIZE - ., 1, 0xcc
	.endr
SYM_CODE_END(early_idt_handler_array)
```

å‰²ã‚Šè¾¼ã¿ãƒ™ã‚¯ã‚¿`i`ã‚’æœ€åˆã«`pushq`ã—ãŸã‚ã¨ã€`jmp early_idt_handler_common`ã§å…±é€šãƒãƒ³ãƒ‰ãƒ©ã«é£›ã°ã—ã¦ã„ã¾ã™ã€‚
ã“ã®å‡¦ç†ã‚’ãƒžã‚¯ãƒ­ã‚’ä½¿ã£ã¦å¿…è¦ãªåˆ†ã ã‘ç”Ÿæˆã—ã¦ã„ã‚‹ã¨ã„ã†ã‚ã‘ã§ã™ã€‚

ã“ã®å‡¦ç†ã€Zigã§æ›¸ãã“ã¨ã‚‚å‡ºæ¥ã¾ã™(ä¸€éƒ¨çœç•¥):

```zig
pub const Isr = fn () callconv(.Naked) void;

pub fn generateIsr(comptime vector: usize) Isr {
    return struct {
        fn handler() callconv(.Naked) void {
            // If the interrupt does not provide an error code, push a dummy one.
            if (vector != 8 and !(vector >= 10 and vector <= 14) and vector != 17) {
                asm volatile (
                    \\pushq $0
                );
            }
            asm volatile (
                \\pushq %[vector]
                :
                : [vector] "n" (vector),
            );
            // Jump to the common ISR.
            asm volatile (
                \\jmp isrCommon
            );
        }
    }.handler;
}

export fn isrCommon() callconv(.Naked) void {
    asm volatile (
        \\(å…±é€šå‡¦ç†ã‚’ã“ã“ã«æ›¸ã)
    );
}
```

Zigã§ã¯`callconv`ã§calling conventionã‚’æŒ‡å®šã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™:

- `.Naked`: é–¢æ•°ã®ãƒ—ãƒ­ãƒ­ãƒ¼ã‚°/ã‚¨ãƒ”ãƒ­ãƒ¼ã‚°ã‚’ç”Ÿæˆã—ãªã„ã€‚ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã‹ã‚‰å‘¼ã³å‡ºã™æ™‚ã€‚
- `.Win`: Windowsã®è¦å‰‡ã«å¾“ã†ã€‚UEFIã‹ã‚‰å‘¼ã³å‡ºã™ã¨ãã¨ã‹ã€‚
- `.C`: Cã®è¦å‰‡ã«å¾“ã†ã€‚Cã‹ã‚‰å‘¼ã³å‡ºã™æ™‚ã¨ã‹ã€‚

`generateIsr()`ã¯ã€ãƒ™ã‚¯ã‚¿ç•ªå·ã‚’å—å–ã‚Šã€ãã®ãƒ™ã‚¯ã‚¿ã‚’`pushq`ã—ãŸå¾Œã«å…±é€šå‡¦ç†ã‚’å‘¼ã³å‡ºã™ã‚ˆã†ãª**é–¢æ•°ã‚’è¿”ã—ã¾ã™**ã€‚
ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã®`.if`ã¨ã¯ã‚’ä½¿ã‚ãšã€åé«˜ç´šè¨€èªžåã®æ§‹æ–‡ã‚’ä½¿ã£ã¦è¿”ã™é–¢æ•°ã®ä¸­èº«ã‚’åˆ¶å¾¡ã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™ã€‚
Zigã¯ã€ã“ã‚“ãªæ„Ÿã˜ã®ãƒ¡ã‚¿ãƒ—ãƒ­ãŒã§ãã‚‹è¨€èªžã§ã™ã€‚ãã†ã€`comptime`ãªã‚‰ã­ã€‚

è¿”ã—ãŸé–¢æ•°ã¯å®Ÿéš›ã«é–¢æ•°ã¨ã—ã¦å®Ÿä½“ã‚’æŒã¡ã€ä»¥ä¸‹ã®ã‚ˆã†ã«ç”Ÿæˆã™ã‚‹ã“ã¨ãŒå‡ºæ¥ã¾ã™:

```zig
pub fn init() void {
    inline for (0..num_system_exceptions) |i| {
        idt.setGate(
            ...,
            isr.generateIsr(i),
        );
    }
    ...
}
```

ã§ã¾ã—ãŸã€`inline for`ã€‚
ã“ã‚Œã«ã‚ˆã£ã¦ã€ã‚³ãƒ³ãƒ‘ã‚¤ãƒ«æ™‚ã«0~`num_system_exceptions - 1`ã¾ã§ã®åˆ†ã ã‘å‰²ã‚Šè¾¼ã¿ãƒãƒ³ãƒ‰ãƒ©ç”¨ã®é–¢æ•°ãŒå®Ÿéš›ã«ç”Ÿæˆã•ã‚Œã¾ã™ã€‚
`nm`ã§è¦‹ã¦ã¿ã‚‹ã¨ã€ã“ã‚“ãªæ„Ÿã˜ã§ã™:

```txt
000000000011ce40 t arch.x86.isr.generateIsr__struct_2549.handler
000000000011ce50 t arch.x86.isr.generateIsr__struct_2552.handler
000000000011ce60 t arch.x86.isr.generateIsr__struct_2555.handler
000000000011ce70 t arch.x86.isr.generateIsr__struct_2558.handler
000000000011ce80 t arch.x86.isr.generateIsr__struct_2561.handler
000000000011ce90 t arch.x86.isr.generateIsr__struct_2564.handler
000000000011cea0 t arch.x86.isr.generateIsr__struct_2567.handler
000000000011ceb0 t arch.x86.isr.generateIsr__struct_2570.handler
```

ã‚‚ã†æ„å‘³ã‚ã‹ã‚‰ãªã„ã‚¢ã‚»ãƒ³ãƒ–ãƒ©ã®ãƒžã‚¯ãƒ­ãªã‚“ã¦ä½¿ã‚ãªãã¦è‰¯ã„ã‚“ã ï¼ã‚„ã£ãŸã€œã€œã€œã€œã€œã€‚

## ã‚¢ã‚¦ãƒˆãƒ­

ã­ã“ã€œã€œã€œã€œã€œã€œã€œã€œã€‚
ã—ã°çŠ¬é£¼ã„ãŸã„ã€œã€œã€œã€œã€œã€œã€œã€œã€œã€œã€‚
åƒããŸããªã„ã‚ˆã€œã€œã€œã€œã€œã€œã€œã€œã€œã€œã€œã€œã€‚
ã„ã¬ã€œã€œã€‚ã­ã“ã€œã€œã€œã€œã€œã€‚
çŠ¬ã‚«ãƒ•ã‚§ã€œã€œã€œã€œã€œã€‚ãƒãƒ¡ãƒ©ãƒ‹ã‚¢ãƒ³ã€œã€œã€œã€œã€‚
ðŸ•
ðŸ•
ðŸ•
ðŸ•
ðŸ˜º
ðŸ•
ðŸ•
ðŸ•

-----

æ¬¡å›žã€ã€ŒZigæŽ¢è¨ª - ã‚¨ã‚³ã‚·ã‚¹ãƒ†ãƒ ç·¨ã€ã§ãŠä¼šã„ã—ã¾ã—ã‚‡ã†ã€‚
